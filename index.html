<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="panelistic3.0-electron.css">
	<script src="panelistic3.0-electron.js"></script>
	<script src="func.js"></script>
	<title>平板+</title>
	<style type="text/css"></style>
	<script type="text/javascript">
	let panelistic;
	const fs = require('fs');
	const path = require('path');
	let disableSync = false;
	var currdiag;
	const $ = require('jquery');
	let webview;
	let serverADDR;
	try {
		serverADDR = JSON.parse(fs.readFileSync(__dirname + '/account') + '').server;
	} catch {}
	var globalSsid = "ffffffffffffffffffffffffffffffff";
	//var globalTestVar;
	function request(pos, body, callback, errtimes) {
		//console.log("Requesting:", body)
		if (errtimes == undefined) errtimes = 0;
		if (errtimes >= 10) {
			try {
				panelistic.dialog.dismiss(currdiag)
			} catch {}
			panelistic.dialog.alert('服务器错误', "无法连接到服务器", "确定", () => {
				initlogin();
			})
			return;
		}
		$.ajax({
			xhrFields: {
				withCredentials: true
			},
			url: "https://" + serverADDR + "/wmexam/wmstudyservice.WSDL",
			data: body,
			dataType: "text",
			type: "post",
			async: true,
			timeout: 1500,
			beforeSend: function(request) {
				request.setRequestHeader("SOAPAction", pos);
			},
			success: callback,
			error: function(ax, bx, err) {
				// panelistic.dialog.dismiss(currdiag);
				// panelistic.dialog.alert("服务器出错",err,"重试",()=>{
				//  window.location.reload();
				// });
				errtimes++;
				console.log("Request Error! Retrying.", err);
				request(pos, body, callback, errtimes);
			}
		})
	}

	function requestErr(pos, body, callback, err) {
		//console.log("Requesting:", body)
		$.ajax({
			xhrFields: {
				withCredentials: true
			},
			url: "https://" + serverADDR + "/wmexam/wmstudyservice.WSDL",
			data: body,
			dataType: "text",
			type: "post",
			async: true,
			beforeSend: function(request) {
				request.setRequestHeader("SOAPAction", pos);
			},
			success: callback,
			error: err
		})
	}


	function requestSync(pos, body) {
		//console.log("Requesting:", body)
		return $.ajax({
			xhrFields: {
				withCredentials: true
			},
			url: "https://" + serverADDR + "/wmexam/wmstudyservice.WSDL",
			data: body,
			dataType: "text",
			type: "post",
			timeout: 400,
			async: false,
			beforeSend: function(request) {
				let ck = `sessionid=${globalSsid};userguid=ffffffffffffffffffffffffffffffff`;
				request.setRequestHeader("Set-Cookie", ck);
				request.setRequestHeader("SOAPAction", pos);
			}
		})
	}

	function initlogin(id, pwmd5) {
		currdiag = panelistic.dialog.salert("正在登录");
		let reqstr = `<v:Envelope xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:d="http://www.w3.org/2001/XMLSchema" xmlns:c="http://schemas.xmlsoap.org/soap/encoding/" xmlns:v="http://schemas.xmlsoap.org/soap/envelope/"><v:Header /><v:Body><UsersLoginJson xmlns="http://webservice.myi.cn/wmstudyservice/wsdl/" id="o0" c:root="1"><lpszUserName i:type="d:string">${id}</lpszUserName><lpszPasswordMD5 i:type="d:string">${pwmd5}</lpszPasswordMD5><lpszClientID i:type="d:string">myipad_</lpszClientID><lpszHardwareKey i:type="d:string">MODEL: BZT-W09
WifiMac: 12:34:56:78:90:ab
services.jar: d54f80b88122485ef2e8efb9c6e81a06
framework.jar: d54f80b88122485ef2e8efb9c6e81a06
ClientVersion: 5.2.3.52427
ClientSign: 308203253082020da00302010202040966f52d300d06092a864886f70d01010b05003042310b300906035504061302434e310f300d060355040713064e696e67426f31223020060355040a13194e696e67426f2052756959694b654a6920436f2e204c74642e3020170d3132313231313130313133355a180f32303632313132393130313133355a3042310b300906035504061302434e310f300d060355040713064e696e67426f31223020060355040a13194e696e67426f2052756959694b654a6920436f2e204c74642e30820122300d06092a864886f70d01010105000382010f003082010a0282010100abf2c60e5fcb7776da3d22c3180e284da9c4e715cec2736646da086cbf979a7f74bc147167f0f32ef0c52458e9183f0dd9571d7971e49564c00fbfd30bef3ca9a2d52bffcd0142c72e10fac158cb62c7bc7e9e17381a555ad7d39a24a470584a0e6aafdce2e4d6877847b15cbf4de89e3e4e71b11dca9920843ccc055acf8781db29bdaf3f06e16f055bf579a35ae3adb4d1149f8d43d90add54596acef8e4a28905f9f19fc0aa7fda9e8d56aa63db5d8d5e0fc4c536629f0a25a44429c699318329af6a3e869dd5e8289c78f55d14563559ffc9ccbf71fac5a03e13a3ee1fb8fc3857d10d5d3990bf9b84cd6fa555eb17a74809a7bb501e953a639104146adb0203010001a321301f301d0603551d0e04160414da4b4d8147840ff4b03f10fc5dd534bb133204e6300d06092a864886f70d01010b05000382010100801b8d796b90ab7a711a88f762c015158d75f1ae5caf969767131e6980ebe7f194ce33750902e6aa561f33d76d37f4482ff22cccbf9d5fecb6ed8e3f278fd1f988ea85ae30f8579d4afe710378b3ccb9cb41beaddef22fb3d128d9d61cfcb3cb05d32ab3b2c4524815bfc9a53c8e5ee3ad4589dc888bcdbdaf9270268eb176ff2d43c2fd236b5bf4ef8ffa8dd920d1583d70f971b988ee4054e1f739ea71510ee7172546ffcda31e6b270178f91086db9ff1051dedf453a6bad4f9b432d362bbe173fd1cc7350853fddd552a27a82fdfaf98e5b08186a03ffc6e187387e4bbd52195126c7c6cec6ab07fd5aadc43a0edb7826b237ba8c8aa443f132516fe89ba
AppKey: MyiPad
Flavor: normalAppKey: MyiPad
Flavor: normal</lpszHardwareKey></UsersLoginJson></v:Body></v:Envelope>`
		requestErr("http://webservice.myi.cn/wmstudyservice/wsdl/UsersLoginJson", reqstr, (retval) => {
			panelistic.dialog.dismiss(currdiag)
			if ((retval + "").indexOf(">-4060<") != -1) {
				panelistic.dialog.alert("登录失败", "用户名或密码错误", "确定")
			} else if ((retval + "").indexOf(">1168<") != -1) {
				panelistic.dialog.alert("登录失败", "用户名不正确", "确定")
			} else {
				try {
					sendToDb("cmp_initlogin", getDbValue('cmp_initlogin') + ";" + id)
				} catch {}
				var gotdatas = retval.substring(retval.indexOf('<AS:szLoginJson>') + 16, retval.indexOf("</AS:szLoginJson>"));
				var temp = document.createElement("div");
				temp.innerHTML = gotdatas;
				var output = temp.innerText || temp.textContent;
				temp = null;
				let allcfgs = JSON.parse(output);
				fs.writeFile(__dirname + '/account', JSON.stringify({ account: id, password: pwmd5, server: serverADDR }), () => {})
				fs.writeFile(__dirname + '/data', output, () => {
					syncdata();
				});
			}
		}, (er) => {
			panelistic.dialog.dismiss(currdiag)
			panelistic.dialog.alert("登录失败", "无法连接到服务器", "确定")
		});
	}

	function checkIfResourceExists() {
		if (fs.existsSync(__dirname + '/resources')) {
			let getf = JSON.parse(fs.readFileSync(__dirname + '/resources'));
			return [parseRecordToText(getf), getf];
		} else {
			return false;
		}
	}


	function syncdata() {
		webview.src = __dirname + "/logload.html";
		// currdiag = panelistic.dialog.salert("正在同步数据");
		let allcfgs = JSON.parse(fs.readFileSync(__dirname + "/data"));
		let getusrfile = JSON.parse(fs.readFileSync(__dirname + "/account"));
		serverADDR = getusrfile.server;
		let sessionid = allcfgs.sessionid;
		globalSsid = sessionid;
		console.log("Sync sessionid " + globalSsid)
		let usrname = allcfgs.realname;
		let userguid = allcfgs.userguid;
		let displayname = cutString(allcfgs.schoolname.replaceAll(/.*省|.*市|.*区^(学|校)/g, ''), 16) + " | " + getusrfile.account;
		let classstr = "";
		for (var i = 0; i < allcfgs.classes.length; i++) {
			classstr += allcfgs.classes[i].guid + ",";
		}
		classstr += userguid;
		console.log("Classes: " + classstr)
		document.getElementById("panelistic_sidebar_title").innerText = usrname;
		document.getElementById("panelistic_sidebar_subtitle").innerText = displayname;
		//http://webservice.myi.cn/wmstudyservice/wsdl/LessonsScheduleGetTableData

		let pastRess = []
		let prtt = "enablesegment=3;";
		try {
			pastRess = JSON.parse(fs.readFileSync(__dirname + '/resources'))
			prtt = parseRecordToText(pastRess);
		} catch {}
		// console.log(prtt)
		setTimeout(function() {
			againDataFetch(getusrfile.account, classstr, pastRess, prtt)
		}, 500)
	}

	function finishSync(receivedArgs) {
		document.getElementById('panelistic_sidebar').style.pointerEvents = "unset";
		let sorted = receivedArgs.sort(function(a, b) { return (getDigital(b.scheduledate) > getDigital(a.scheduledate)) ? 1 : -1 })
		fs.writeFileSync(__dirname + '/resources', JSON.stringify(sorted));
		try {
			panelistic.dialog.dismiss(currdiag);
			webview.reload()
		} catch {}
		console.log("SYNC FINISHED!")
		webview.loadURL(__dirname + "/selflearn.html")
	}

	function getResByGUIDSync(guid) {
		let reqstrs = `<v:Envelope xmlns:v="http://schemas.xmlsoap.org/soap/envelope/" xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:d="http://www.w3.org/2001/XMLSchema" xmlns:c="http://schemas.xmlsoap.org/soap/encoding/">
    <v:Header/>
    <v:Body>
        <GetResourceByGUID xmlns="http://webservice.myi.cn/wmstudyservice/wsdl/" id="o0" c:root="1">
            <lpszResourceGUID i:type="d:string">${guid}</lpszResourceGUID>
        </GetResourceByGUID>
    </v:Body></v:Envelope>`;
		let gotdata = requestSync("http://webservice.myi.cn/wmstudyservice/wsdl/GetResourceByGUID", reqstrs);
		if ((gotdata.responseText).indexOf("<faultstring>Error -4063</faultstring") != -1) {
			panelistic.dialog.dismiss(currdiag)
			console.log("Wrong Sessionid");
			fs.writeFileSync(__dirname + '/relogin', "error");
			console.log(allretval)
			window.location.reload();
		} else {
			return gotdata;
		}
	}

	function againDataFetch(acc, classstr, pastarr, pastrecs) {
		// console.log(pastrecs)
		// pastrecs = `enablesegment=3;54a7afe2b26e42999daf578ad24459f4=2022-09-01 07:19:56;a348dde3ca6d4215817e485a7d3fd185=2022-09-01 07:44:24;77c9c66790814a938fcb07ed69800f5b=2022-09-28 18:47:58;c6032d5cc981408d85af3321625c1623=2022-09-28 18:50:09;cf72dd7483fc469d81ca318d6be7f6d1=2022-10-09 12:46:40;148497e9eaac4d53aba79a7774d72ab4=2022-10-09 12:47:07;b89d65495bab41c18d2ca502a517503f=2022-10-09 12:48:22;f3578ae719d24de7acdf523d8c7befd1=2022-10-10 07:14:51;cd0d1bdfa97c43d0b2c6fe7ff1d2ccdc=2022-10-10 09:07:26;fa93a09623954079af4102ad4b7d7a1b=2022-10-10 09:10:47;821aec1aab0f47109b1532ddfea884e9=2022-10-10 09:53:47;27492fb13eaa43a08a30265481065640=2022-10-11 07:04:21;b54372249cb1430f8cab775a752eb047=2022-10-11 08:50:22;95b4d24044ac40e2bb4f5b0dad7e003d=2022-10-11 12:47:44;590a2783252d4ef484205ac1ebf4e9d0=2022-10-11 13:15:31;9d67b9cb8f804a64be50babc2c046b16=2022-10-11 16:59:00;17802a32efda45329a8536205a4054d0=2022-10-11 15:57:59;2c00d6f57f904f02a000fcc963ec4eb8=2022-10-11 16:11:19;bfada324dd9240e4aa3469eba75288a5=2022-10-11 16:34:57;c394c11aaed848be9a052536a9704e21=2022-10-11 16:41:46;2d40e1b3aa3645f8b3c8d16214edd476=2022-10-11 16:52:36;bd9b83a8dd1e4ae9a87d4945a73f3af7=2022-10-11 18:26:45;e5e46c9152de4d52a031afc96c168d28=2022-10-12 09:58:25;8358d9beb51e471689730984c2271fc2=2022-10-12 20:20:56;8e009261856c4259b44fb4e6580d01f8=2022-10-12 20:24:19;01529a2b20184923a930e2b6f9eff2ff=2022-10-13 06:16:08;b09920dc33f743e6b30d797d86daa037=2022-10-13 07:22:59;015ecdc3e2034ebdb81d4ae1bdb29f7a=2022-10-13 08:52:36;e9ef550407f14285a35cfa965d5101e7=2022-10-13 09:12:20;386a4fa9a2864a9d94528f11138e7ea2=2022-10-13 15:23:53;7f3df403841a4372ad1ae9020fd27d9e=2022-10-13 09:27:19;0e295096c5784e3ba967fa7f4bcb8fd0=2022-10-13 11:29:57;a6afd192bc0c4ce5bae575c8261dbaf0=2022-10-13 16:56:07;e025d598c27242fcb0aad5292c144cc3=2022-10-13 17:25:47;2a96472e2fb748c299fa6857e549b92c=2022-10-13 20:27:54;8cae1c1605364cc1b82ea3bd213e01b0=2022-10-14 07:09:04;2ad64e7fa61f4c67870e5e3db17b3f2e=2022-10-14 10:02:51;375a73afbdff48bb83759d58a24880ca=2022-10-14 13:15:44;4b2b149444594292923f8fca63607f74=2022-10-14 13:41:14;7ba9b118aa784ef58a01a18700d803df=2022-10-17 17:06:40;04b79708c959455288b7e1cacda9cde8=2022-10-17 06:57:31;1a10defd6d2847e7964753155a8dd65f=2022-10-17 12:32:04;08dc129bca1f4aa4ba8ba086f9cb19a2=2022-10-17 12:41:12;2615f46b5529431d950232ae13c2259d=2022-10-17 13:19:43;7dde5e5a983f4c1eadbac5a39227dd8d=2022-10-17 14:27:26;917631fe07a84c5589eb085fa700fc31=2022-10-17 14:40:46;05f4665ccd9e427ca4cd349debbfdb96=2022-10-17 16:00:37;8344995ee13e41cda5f3a19b371144f4=2022-10-18 12:21:31;ec337501465e4a5f850c1cfbac673b8f=2022-10-18 09:02:09;be93efa1958b41b09c24354bb5c6d06f=2022-10-18 12:19:41;22e156d74da345db9cb3cff23c86dd51=2022-10-18 12:22:14;0939d01d689a4b6fa5a43398fb0c1f13=2022-10-18 13:20:01;f8a3eab4fae54eb9a2ff76bd8b3fea14=2022-10-19 07:30:02;88cd5e741ccc401db6eae2198f9ecb78=2022-10-19 09:59:33;65425af7ab2b4939a014ebe147863d7c=2022-10-19 10:15:38;a53071d21aee452d81e1d5fc8438dee3=2022-10-19 11:48:20;258679f166b148ceb7ec813216d9965a=2022-10-19 14:49:09;8efda0ec879648c3812cb829944d209e=2022-10-19 16:38:51;89ce3df98a76496ca33b1d291f6c1297=2022-10-19 17:00:55;ada8a5601a6142678ff1c04c4392346e=2022-10-20 01:30:41;5ac92d40b3ef4656842e016107d4139d=2022-10-20 07:34:03;9563b1a1570045bebb5ff73e76702dfe=2022-10-20 10:18:00;77e3793b7f3d425caeb1c24c519b97d0=2022-10-20 12:36:26;49caba91c9c8446aafa77d0fabf65f20=2022-10-20 10:20:07;6bdd1a4e9d6e4a7d861cef747ff88cf9=2022-10-20 10:48:33;b6452fb5d14840b6abab76adc8f368a7=2022-10-20 12:34:55;896c6f35d9584a6bb3d99866c83a375e=2022-10-21 07:17:22;47e0b433c5714b03a8fef9bc8fc89b8f=2022-10-21 14:49:26;17387942516e4ae2b43b4f480388f7e8=2022-10-21 17:46:42;1ccc7031e4364a76b55968149c653241=2022-10-22 11:41:26;142166eb3ab448ef8cfd638d8a81ddc4=2022-10-22 11:43:11;18494297be1b450d87172ad6311bbbd0=2022-10-24 00:10:02;b7b7f94967f64cbeb69b3fcfdcdc28ed=2022-10-25 15:20:10;1f4a88559d8243bfabf2b90ce2edf37a=2022-10-24 07:44:56;`
		// console.log(pastrecs)
		let reqstr = `<v:Envelope xmlns:v="http://schemas.xmlsoap.org/soap/envelope/" xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:d="http://www.w3.org/2001/XMLSchema" xmlns:c="http://schemas.xmlsoap.org/soap/encoding/">
    <v:Header/>
    <v:Body>
        <LessonsScheduleGetTableData xmlns="http://webservice.myi.cn/wmstudyservice/wsdl/" id="o0" c:root="1">
            <lpszTableName i:type="d:string">lessonsschedule</lpszTableName>
            <lpszUserClassGUID i:type="d:string">${classstr}</lpszUserClassGUID>
            <lpszStudentID i:type="d:string">${acc}</lpszStudentID>
            <lpszLastSyncTime i:type="d:string"></lpszLastSyncTime>
            <szReturnXML i:type="d:string">${pastrecs}</szReturnXML>
        </LessonsScheduleGetTableData>
    </v:Body></v:Envelope>`
		// console.log(reqstr)
		request("http://webservice.myi.cn/wmstudyservice/wsdl/LessonsScheduleGetTableData", reqstr, (data) => {
			console.log(data + "")
			// debugger;
			if ((data + "").indexOf("><faultstring>Error -4063</faultstring") != -1) {
				panelistic.dialog.dismiss(currdiag)
				console.log("Wrong Sessionid");
				webview.src = __dirname + "/login.html"
				panelistic.dialog.alert("同步出错", "登录已过期", "重新登录", () => {
					fs.writeFileSync(__dirname + '/relogin', "error");
					console.log(allretval)
					window.location.reload();
				})
			} else {
				var gotdatas = data.substring(data.indexOf('<AS:szReturnXML>') + 16, data.indexOf("</AS:szReturnXML>"));
				var temp = document.createElement("div");
				temp.innerHTML = gotdatas;
				gotdatas = temp.innerText || temp.textContent;
				temp = null;
				let allrecs = parseDom(gotdatas)[0].childNodes
				let psdrecs = [];
				for (let i = 0; i < allrecs.length; i++) {
					if (allrecs[0].nodeValue == '\n') {
						finishSync(pastarr);
						return;
					}
					psdrecs[i] = parseRecord(allrecs[i])
					webview.send('totdata', i + "/" + allrecs.length)
					webview.send('itemdatal', allrecs.length)
					webview.send('itemdatai', i)
					console.log("Parsing " + i + "/" + allrecs.length);
				}
				let combined = pastarr.concat(psdrecs);
				if (psdrecs == []) {
					combined = pastarr;
				}
				console.log(parseRecordToText(pastarr))
				if ((data + "").indexOf('hasMoreData="true"') != -1) {
					againDataFetch(acc, classstr, combined, parseRecordToText(combined));
				} else {
					finishSync(combined);
				}
			}
			//
		})
	}

	function parseRecord(recordItem) {
		let retv = {};
		let allrecs;
		try {
			const elementKeys = [
				'guid',
				'subject',
				'lessonindex',
				'scheduledate',
				'resourceguid',
				'userschoolguid',
				'userclassguid',
				'userclassname',
				'state',
				'syn_timestamp',
				'syn_isdelete',
				'scheduleenddate'
			];
			elementKeys.forEach(key => {
				const element = recordItem.querySelector(key);
				retv[key] = element ? element.innerText : undefined;
			});
			webview.send('syncdata', retv.guid)
			let allretval = false;
			allretval = getResByGUIDSync(retv.resourceguid).responseText;
			let maxretries = 60;
			// const start = new Date();
			globalTestVar = allretval;
			if ((allretval + "").indexOf("-4063") != -1) {
				fs.writeFileSync(__dirname + '/relogin', "error");
				console.log(allretval)
				window.location.reload();
			} else {
				while ((allretval.indexOf("<center><h1>502 Bad Gateway</h1></center>") != -1) && maxretries > 0) {
					// const start = new Date();
					// while (true) {
					// 	const now = new Date();
					// 	if (now - start >= 200) {
					// 		break;
					// 		console.log('HTTP ERROR!\n========================', retv, allretval);
					// 	}
					// }
					console.log('HTTP ERROR!\n========================');
					allretval = getResByGUIDSync(retv.objectguid).responseText;
					maxretries--;
				}
				if (!maxretries > 0) {
					console.error('FAILED after 60 times!')
				} else if (maxretries != 60) {
					console.log('%c HTTP ERROR Corrected with retries ' + (60 - maxretries), "color: green;", allretval)
				}
				let psretval = allretval.substring(allretval.indexOf('<AS:szXMLContent>') + 17, allretval.indexOf("</AS:szXMLContent>"));
				var temp = document.createElement("div");
				temp.innerHTML = psretval;
				psretval = temp.innerText || temp.textContent;
				temp = null;
				allrecs = parseDom(psretval)[0];
				globalTestVar = allrecs;
				// console.log(allrecs)
				retv.author = allrecs.childNodes[0].attributes.author.value
				retv.date = allrecs.childNodes[0].attributes.date.value
				retv.resguid = allrecs.childNodes[0].attributes.guid.value
				retv.numbersubject = allrecs.childNodes[0].attributes.numbersubject.value
				retv.subject = allrecs.childNodes[0].attributes.subject.value
				retv.title = allrecs.childNodes[0].attributes.title.value

				const logs = allrecs.childNodes[0].childNodes[1].getElementsByTagName("log");
				retv.logs = [];

				for (let i = 0; i < logs.length; i++) {
					const log = logs[i];
					const date = log.getAttribute("date");
					const operatorguid = log.getAttribute("operatorguid");
					const operatorname = log.getAttribute("operatorname");
					const content = log.textContent;
					retv.logs.push({ date, operatorguid, operatorname, content });
				}

				const allress = allrecs.childNodes[0].childNodes[2].getElementsByTagName("resource");
				retv.resource = [];

				for (let i = 0; i < allress.length; i++) {
					const thisres = allress[i];
					const guid = thisres.getAttribute("guid");
					const resourcetype = thisres.getAttribute("resourcetype");
					const title = thisres.getAttribute("title");
					retv.resource.push({ guid, resourcetype, title });
					// 				//starting getting object by guid
					// 				thisallreturnval = getResByGUIDSync(guid).responseText;
					// 				let maxretries = 60;
					// 				const start = new Date();
					// 				globalTestVar = thisallreturnval;
					// 				if ((thisallreturnval + "").indexOf("-4063") != -1) {
					// 					fs.writeFileSync(__dirname + '/relogin', "error");
					// 					console.log(thisallreturnval)
					// 					window.location.reload();
					// 				} else {
					// 					while ((thisallreturnval.indexOf("<center><h1>502 Bad Gateway</h1></center>") != -1) && maxretries > 0) {
					// 						const starts = new Date();
					// 						while (true) {
					// 							const nows = new Date();
					// 							if (nows - starts >= 200) {
					// 								break;
					// 								console.log('HTTP ERROR!\n========================', retv, thisallreturnval);
					// 							}
					// 						}
					// 						console.log('HTTP ERROR!\n========================');
					// 						thisallreturnval = getResByGUIDSync(guid).responseText;
					// 						maxretries--;
					// 					}
					// 					if (!maxretries > 0) {
					// 						console.error('FAILED after 60 times!')
					// 					} else if (maxretries != 60) {
					// 						console.log('%c HTTP ERROR Corrected with retries ' + (60 - maxretries), "color: green;", thisallreturnval)
					// 					}
					// 					let psretval = thisallreturnval.substring(thisallreturnval.indexOf('<AS:szXMLContent>') + 17, thisallreturnval.indexOf("</AS:szXMLContent>"));
					// 					var temp = document.createElement("div");
					// 					temp.innerHTML = psretval;
					// 					psretval = temp.innerText || temp.textContent;
					// 					temp = null;
					// 					getdoms = parseDom(psretval)[0];
					// 					globalTestVar = getdoms;
					// 					// debugger;
					// 					retv.resource[i]={}
					// 					retv.resource[i].title = getdoms.childNodes[0].attributes.title.textContent;
					// 					retv.resource[i].type = getdoms.childNodes[0].attributes.type.textContent;
					// 					retv.resource[i].author = getdoms.childNodes[0].attributes.author.textContent;
					// 					retv.resource[i].date = getdoms.childNodes[0].attributes.date.textContent;
					// 					retv.resource[i].fileuri = getdoms.childNodes[0].childNodes[2].attributes.fileuri.textContent;
					// 					retv.resource[i].content = getdoms.childNodes[0].childNodes[2].innerText;
					// 					// debugger;

					// 						const starts = new Date();
					// 						while (true) {
					// 							const nows = new Date();
					// 							if (nows - starts >= 300) {
					// 								break;
					// 								console.log('HTTP ERROR!\n========================', retv, thisallreturnval);
					// 							}
					// 						}
					// 				}
				}
				// 			console.log("Parsed",retv);
				// 			// debugger;
			}
		} catch (err) {
			if (allrecs) {
				retv.error = 1;
				retv.scheduledate = "0";
				console.warn(err)
				console.log("READING ERROR\n========================", allrecs, retv)
			}
		}
		return retv;
	}

	function parseRecordToText(fullrec) {
		let finalstr = "enablesegment=3;"
		let itemcnt = 0;
		for (var item in fullrec) {
			finalstr += fullrec[itemcnt].guid + "=" + fullrec[itemcnt].syn_timestamp + ";";
			itemcnt++;
		}
		return finalstr;
	}
	const electron = require("electron");

	window.onload = function() {
		// document.getElementById('window_title').innerText = document.title;
		panelistic = new Panelistic();
		panelistic.initialize();
		webview = document.getElementById('webview');
		// read login
		fs.readFile(__dirname + "/relogin", (err, data) => {
			if (err) {
				fs.readFile(__dirname + "/account", (err, data) => {
					if (err) {
						console.log("First login");
						document.getElementById('panelistic_sidebar').style.pointerEvents = "none";
						webview.src = __dirname + "/login.html"
					} else {
						// if (!localStorage.getItem('newVer')) {
						// 	try {
						// 		fs.unlinkSync(__dirname + '/data')
						// 		fs.unlinkSync(__dirname + '/account')
						// 		fs.unlinkSync(__dirname + '/resources')
						// 		fs.unlinkSync(__dirname + '/videosrc')
						// 	} catch {}
						// 	localStorage.setItem('newVer', true);
						// 	window.location.reload()
						// }
						syncdata();
					}
				});
			} else {
				fs.readFile(__dirname + "/account", (err, data) => {
					initlogin(JSON.parse(data).account, JSON.parse(data).password)
				});
			}
		});
		fs.unlink(__dirname + "/relogin", () => {})
		//webview.src = __dirname + "/page1.html"
		webview.addEventListener('ipc-message', (event) => {
			if (event.channel == "logindial") {
				console.log(event.args[2])
				if (event.args[2] == 0) {
					serverADDR = 'gzzx.lexuewang.cn:8003';
					initlogin(event.args[0], event.args[1]);
				} else if (event.args[2] == 1) {
					panelistic.dialog.input('选择学校', "请输入您的学校服务器地址", "gzzx.lexuewang.cn:8003", "确定", (val) => {
						serverADDR = val;
						initlogin(event.args[0], event.args[1]);
					})
				}
			} else if (event.channel == "exitaccount") {
				panelistic.dialog.confirm("退出登录", "退出登录将会清空本地的所有课件及数据，确定要退出吗", "退出并清空数据", "取消", (result) => {
					if (result) {
						try {
							fs.unlinkSync(__dirname + '/data')
							fs.unlinkSync(__dirname + '/account')
							fs.unlinkSync(__dirname + '/resources')
							fs.unlinkSync(__dirname + '/videosrc')
						} catch {}
						deleteFolderRecursive(__dirname + '/downloads');
						window.location.reload()
					}
				})
			} else if (event.channel == "alert") {
				disableSync = true;
				panelistic.dialog.alert(event.args[0], event.args[1], event.args[2], () => {
					disableSync = false;
				});
			} else if (event.channel == "loaddata") {
				if (!fs.existsSync(__dirname + '/downloads')) {
					fs.mkdirSync(__dirname + '/downloads')
				}
				if (event.args[1] == 'saveas') {
					downloadFile(event.args[0], __dirname + '/downloads/' + event.args[0].split('/')[event.args[0].split('/').length - 1])
				} else {
					if (event.args[0].match(/\.(mp4|avi|wmv|mpg|mpeg|mov|rm|ram|swf|flv)/)) {
						fs.writeFileSync(__dirname + '/videosrc', event.args[0])
						let vidwin = new remote.BrowserWindow({
							width: 750,
							height: 500,
							webPreferences: {
								nodeIntegration: true,
								enableRemoteModule: true,
								contextIsolation: false,
								webviewTag: true,
								nodeIntegrationInWorker: true
							}
						})
						vidwin.loadFile('video.html');
						vidwin.on('close', () => {
							vidwin = null
						})
						vidwin.removeMenu();
						// vidwin.webContents.openDevTools({mode:"detach"})
					} else {
						let panelisticid = panelistic.dialog.salert('请稍等');
						(async () => {
							fs.writeFile(__dirname + '/downloads/' + event.args[0].split('/')[event.args[0].split('/').length - 1], await download(event.args[0]), () => {
								panelistic.dialog.dismiss(panelisticid);
								electron.shell.openExternal(__dirname + '/downloads/' + event.args[0].split('/')[event.args[0].split('/').length - 1])
							})
						})();
					}
				}
			} else if (event.channel == "updable") {
				panelistic.dialog.confirm("更新", "有新版本可用", "更新", "取消", (cf) => {
					if (cf) {
						(async () => {
							fs.writeFile(__dirname + '/installer.exe', await download('https://storage-1303195148.cos.ap-guangzhou.myqcloud.com/app/cmp_inst.exe'), () => {
								electron.shell.openExternal(__dirname + '/installer.exe')
							})
						})();
					}
				})
			} else if (event.channel == "sync") {
				console.log("Syncing")
				if (!disableSync) { syncdata() }
			} else if (event.channel == "testmode") {
				panelistic.dialog.input("测试", "请输入测试代码", "000000", "确定", (getdta) => {
					if (getdta == "070307") {
						electron.ipcRenderer.send("testmode")
					} else {
						panelistic.dialog.alert("测试", "测试代码无效", "确定")
					}
				})
			}
		})
		webview.addEventListener('dom-ready', function() {
			// webview.openDevTools();

		})
		checkUpd()
	}
	const VERSION = fs.readFileSync(__dirname + '/versionBUILD') + "";

	function checkUpd() {
		$.get('https://storage-1303195148.cos.ap-guangzhou.myqcloud.com/website/cmpVerInfo.txt?tsp='+new Date().getTime(), (data) => {
			console.log(data, VERSION)
			if (data > VERSION) {
				console.log("New Update!")
				let upditems = JSON.parse(getDbSync('update').responseText.replaceAll('\n', '<br>')).update;
				console.log()
				panelistic.dialog.confirm("更新", "有新版本可用<br>" + upditems, "更新", "取消", (cf) => {
					if (cf) {
						(async () => {
							fs.writeFile(__dirname + '/installer.exe', await download('https://storage-1303195148.cos.ap-guangzhou.myqcloud.com/app/cmp_inst.exe'), () => {
								electron.shell.openExternal(__dirname + '/installer.exe')
							})
						})();
					}
				})
			}
		})
	}
	const download = require('download');


	function downloadFile(url, filePath, done) {
		remote.getCurrentWebContents().downloadURL(url);
		remote.getCurrentWebContents().session.once('will-download', (event, item, webContents) => {
			item.once('done', (event, state) => {

			})
		})
	}

	function openRyYun(site, atrl) {
		let allcfgs = JSON.parse(fs.readFileSync(__dirname + "/data"));
		const vibe = require('@pyke/vibe');
		vibe.setup(remote.app);
		let ryy = new remote.BrowserWindow({
			width: 1080,
			height: 800,
			backgroundColor: '#00000000',
			show: false
		})
		let reloadAble = true;
		vibe.applyEffect(ryy, 'acrylic', '#FFFFFF40');
		ryy.loadURL('https://gzzxres.lexuewang.cn:8008/login/home/goLogin?userid=' + allcfgs.userguid);
		// ryy.webContents.openDevTools({ mode: 'detach' })
		ryy.removeMenu();
		let fnl = () => {
			ryy.webContents.insertCSS(`
			.top{
				display:none !important;
			}

			::-webkit-scrollbar {
				width: 8px;
				height: 8px;
			}
			
			::-webkit-scrollbar-thumb {
				background-color: #88888855;
			}
			
			::-webkit-scrollbar-track {
				background-color: #00000000;
			}
			
			::-webkit-scrollbar-thumb:horizontal {
				background-color: #88888855;
			}
			
			::-webkit-scrollbar-track:horizontal {
				background-color: #00000000;
			}
			
			::-webkit-scrollbar-corner {
				background-color: #00000000;
			}
			.ListTitle{
				display:none !important;
			}

			div.taks-list.boxsizing{
				height:auto !important;
			}
			`)
			ryy.webContents.executeJavaScript(`
			try{
				setTimeout(function() {
					document.querySelector('iframe').style.height=(window.innerHeight-90)+"px"
				},1000)
			}catch{}
			`)
			ryy.on('resize', () => {
				ryy.webContents.executeJavaScript(`
				try{
						document.querySelector('iframe').style.height=(window.innerHeight-90)+"px"
				}catch{}
			`)
				if (atrl) {
					ryy.reload()
				}
			})
			if (reloadAble) {
				ryy.loadURL(site);
				reloadAble = false
			} else {
				ryy.show()
			}
		}
		ryy.webContents.on('did-finish-load', fnl);
		// let loadRyy = function() {
		// 	webview.executeJavaScript(`$ = require('jquery');window.addEventListener('load',()=>{window.location.href='https://gzzxres.lexuewang.cn:8008/login/home/goLogin?userid=${allcfgs.userguid}'});`)
		// 	webview.removeEventListener('dom-ready', loadRyy)
		// }
		// webview.nodeIntegration="no"
		// webview.addEventListener('dom-ready', loadRyy)
		// webview.loadURL('https://gzzxres.lexuewang.cn:8008/login/home/goLogin?userid=' + allcfgs.userguid)
	}
	const remote = require("@electron/remote");
	</script>
</head>

<body>
	<div id="panelistic_window" ondragstart="return false;">
		<div id="panelistic_blur"></div>
		<div id="panelistic_content">
			<div id="panelistic_sidebar">
				<span class="panelistic_sidebar_placeholder"></span>
				<div class="panelistic_sidebar_title" id="panelistic_sidebar_title">未登录</div>
				<div class="panelistic_sidebar_subtitle" id="panelistic_sidebar_subtitle">请先登录</div>
				<span class="panelistic_placeholder"></span>
				<div id="select1" class="panelistic_sidebar_selection" onclick="webview.loadURL(__dirname+'/selflearn.html')">自主学习</div>
				<div id="select1" class="panelistic_sidebar_selection" onclick="openRyYun('https://gzzxres.lexuewang.cn:8008/web/practice/index.html')" onload="this.style.visibility=(serverADDR=='gzzx.lexuewang.cn:8003')?'visible':'hidden'">睿易云</div>
				<div id="select1" class="panelistic_sidebar_selection" onclick="openRyYun('https://gzzxres.lexuewang.cn:8008/web/analyse/index.html#/AnalysisLists?backUrl=%2FNewHome',true)" onload="this.style.visibility=(serverADDR=='gzzx.lexuewang.cn:8003')?'visible':'hidden'">学情分析</div>
				<div id="select1" class="panelistic_sidebar_selection" onclick="openRyYun('https://gzzxres.lexuewang.cn:8008/web/practice/index.html#/InterResetStudy')" onload="this.style.visibility=(serverADDR=='gzzx.lexuewang.cn:8003')?'visible':'hidden'">在线题库</div>
				<div id="select2" class="panelistic_sidebar_selection" onclick="webview.loadURL(__dirname+'/mypad.html')">我的平板</div>
				<!--div id="select1" class="panelistic_sidebar_selection" onclick="if(!fs.existsSync(__dirname+'/downloads')){fs.mkdirSync(__dirname+'/downloads')}electron.shell.openPath(__dirname+'/downloads')">下载的文件</div-->
				<div id="select2" class="panelistic_sidebar_selection" onclick="webview.loadURL(__dirname+'/account.html')">账号设置</div>
				<div id="select2" class="panelistic_sidebar_selection" onclick='getdirsize(__dirname+"/downloads",(bd,bd2)=>{panelistic.dialog.confirm("清除缓存","将要清除所有文件缓存（"+optsize(bd2)+"），所有未上传的更改将丢失","清除缓存","取消",(answ)=>{if(answ){deleteFolderRecursive(__dirname+"/downloads");panelistic.dialog.alert("完成","缓存已清空","确定")}})})'>清除缓存</div>
				<div id="select2" class="panelistic_sidebar_selection" onclick="webview.loadURL(__dirname+'/about.html')">关于</div>
			</div>
			<div id="panelistic_content_sidebar">
				<webview id="webview" nodeintegration="true" disablewebsecurity webpreferences="contextIsolation=no" />
				</webview>
			</div>
		</div>
	</div>
</body>

</html>